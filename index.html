<!DOCTYPE html>
<html lang="en">
<head>
    <title>Sheet Music Generator</title>
    <link rel="icon" href="./music.svg">
    <style>
        @font-face {
            font-family:bravura;
            src: url("/fonts/Bravura.woff2");
        }
        body {
            margin: 0;
            /* overflow:hidden; */
        }
        #animation {
            position:absolute;
            top: 0;
        }

        #sound {
            position:absolute;
            top: 10px;
            left: 10px;
        }
        #randomise {
            position: absolute;
            top: 10px;
            left: 200px;
        }
    </style>
</head>
<body>
    <canvas id="sheet-music"></canvas>
    <canvas id="animation"></canvas>
    <button id="sound">Play Sound</button>
    <button id="randomise" onClick="randomise()">Randomise</button>
</body>
<script>
    'use strict'
    var CANVAS
    var ANIMATION
    var SOUND = new AudioContext()
    var BUTTON = document.getElementById('sound')

    const songObject = {
    }

    const songDurations = []
    const songNoteNames = []

    const noteHead = {
        4:      `\ue0a2`,
        2:      `\ue0a3`,
        1:      `\ue0a4`,
        0.5:    `\ue0a4`,
        0.25:   `\ue0a4`
    }

    const frequencyNoteMap = {
        "C0":16.05,
        "C#0/Db0":17.01,
        "D0":18.02,
        "D#0/Eb0":19.09,
        "E0":20.23,
        "F0":21.43,
        "F#0/Gb0":22.70,
        "G0":24.05,
        "G#0/Ab0":25.48,
        "A0":27.00,
        "A#0/Bb0":28.61,
        "B0":30.31,
        "C1":32.11,
        "C#1/Db1":34.02,
        "D1":36.04,
        "D#1/Eb1":38.18,
        "E1":40.45,
        "F1":42.86,
        "F#1/Gb1":45.41,
        "G1":48.11,
        "G#1/Ab1":50.97,
        "A1":54.00,
        "A#1/Bb1":57.21,
        "B1":60.61,
        "C2":64.22,
        "C#2/Db2":68.04,
        "D2":72.08,
        "D#2/Eb2":76.37,
        "E2":80.91,
        "F2":85.72,
        "F#2/Gb2":90.82,
        "G2":96.22,
        "G#2/Ab2":101.94,
        "A2":108.00,
        "A#2/Bb2":114.42,
        "B2":121.23,
        "C3":128.43,
        "C#3/Db3":136.07,
        "D3":144.16,
        "D#3/Eb3":152.74,
        "E3":161.82,
        "F3":171.44,
        "F#3/Gb3":181.63,
        "G3":192.43,
        "G#3/Ab3":203.88,
        "A3":216.00,
        "A#3/Bb3":228.84,
        "B3":242.45,
        "C4":256.87,
        "C#4/Db4":272.14,
        "D4":288.33,
        "D#4/Eb4":305.47,
        "E4":323.63,
        "F4":342.88,
        "F#4/Gb4":363.27,
        "G4":384.87,
        "G#4/Ab4":407.75,
        "A4":432.00,
        "A#4/Bb4":457.69,
        "B4":484.90,
        "C5":513.74,
        "C#5/Db5":544.29,
        "D5":576.65,
        "D#5/Eb5":610.94,
        "E5":647.27,
        "F5":685.76,
        "F#5/Gb5":726.53,
        "G5":769.74,
        "G#5/Ab5":815.51,
        "A5":864.00,
        "A#5/Bb5":915.38,
        "B5":969.81,
        "C6":1027.47,
        "C#6/Db6":1088.57,
        "D6":1153.30,
        "D#6/Eb6":1221.88,
        "E6":1294.54,
        "F6":1371.51,
        "F#6/Gb6":1453.07,
        "G6":1539.47,
        "G#6/Ab6":1631.01,
        "A6":1728.00,
        "A#6/Bb6":1830.75,
        "B6":1939.61,
        "C7":2054.95,
        "C#7/Db7":2177.14,
        "D7":2306.60,
        "D#7/Eb7":2443.76,
        "E7":2589.07,
        "F7":2743.03,
        "F#7/Gb7":2906.14,
        "G7":3078.95,
        "G#7/Ab7":3262.03,
        "A7":3456.00,
        "A#7/Bb7":3661.50,
        "B7":3879.23,
        "C8":4109.90,
        "C#8/Db8":4354.29,
        "D8":4613.21,
        "D#8/Eb8":4887.52,
        "E8":5178.15,
        "F8":5486.06,
        "F#8/Gb8":5812.28,
        "G8":6157.89,
        "G#8/Ab8":6524.06,
        "A8":6912.00,
        "A#8/Bb8":7323.01,
        "B8":7758.46
    }
    const offsetNoteMap = {
        "C0":0,
        "D0":0,
        "E0":0,
        "F0":0,
        "G0":0,
        "A0":0,
        "B0":0,
        "C1":0,
        "D1":0,
        "E1":0,
        "F1":0,
        "G1":0,
        "A1":0,
        "B1":0,
        "C2":24,
        "D2":23,
        "E2":22,
        "F2":21,
        "G2":20,
        "A2":19,
        "B2":18,
        "C3":17,
        "D3":16,
        "E3":15,
        "F3":14,
        "G3":13,
        "A3":12,
        "B3":11,
        "C4":10,
        "D4":9,
        "E4":8,
        "F4":7,
        "G4":6,
        "A4":5,
        "B4":4,
        "C5":3,
        "D5":2,
        "E5":1,
        "F5":0,
        "G5":-1,
        "A5":-2,
        "B5":-3,
        "C6":-4,
        "D6":-5,
        "E6":-6,
        "F6":-7,
        "G6":-8,
        "A6":-9,
        "B6":0,
        "C7":0,
        "D7":0,
        "E7":0,
        "F7":0,
        "G7":0,
        "A7":0,
        "B7":0,
        "C8":0,
        "D8":0,
        "E8":0,
        "F8":0,
        "G8":0,
        "A8":0,
        "B8":0,
    }

    const cPentatonicMajor = [
        "C4",
        "D4",
        "E4",
        "G4",
        "A4"
    ]
    const cMajor = [
        "C4",
        "D4",
        "E4",
        "F4",
        "G4",
        "A4",
        "B4",
        "C5"
    ]

    const durations = [
        0.25, 0.5, 1
    ]
    const bpm = 60 / 100
    function randomise(){
        const noteList = cPentatonicMajor
    Array(70).fill(null).forEach((v, ind) => {
        songObject[ind] = {
            duration: durations[Math.floor(Math.random()*durations.length)] * bpm, 
            name: noteList[Math.floor(Math.random() * noteList.length)]}
    })
    main()
    }
    console.log(songObject, songDurations, songNoteNames)
    function main() {
        CANVAS = document.getElementById('sheet-music')
        ANIMATION = document.getElementById('animation')

        fitToScreen() 
    }
    function fitToScreen() {
        CANVAS.width = window.innerWidth
        CANVAS.height = window.innerHeight
        ANIMATION.width = window.innerWidth
        ANIMATION.height = window.innerHeight
        drawSheet()
    }

   
    var unitDistance = 120
    var topLine = 50
    var distanceBetweenStaves = 160
    var startStaffX = 40
    var initialOffset = 100
    var barWidth = window.innerWidth - 2 * startStaffX - initialOffset
    
    window.addEventListener('resize', fitToScreen)
    
    function drawSheet() {
        var {width, height} = CANVAS
        var ctx = CANVAS.getContext('2d')
        ctx.fillStyle = "black"
        ctx.font = "40px bravura"
        ctx.fillText("\uE084", startStaffX + 43, topLine + 10)                                 // Time signatures  - treble
        ctx.fillText("\uE084", startStaffX + 43, topLine + 30)
        
        ctx.fillText("\uE084", startStaffX + 43, topLine + 60 + 10)               //  - bass
        ctx.fillText("\uE084", startStaffX + 43, topLine + 60 + 30)

        // |~~~~~~~~~~~~~~ -- | Note placement | -- ~~~~~~~~~~~~~~| \\
        
        var halfToneDistance = 5
        var songDistance = 0
        var totalSongDistance = Object.values(songObject).reduce((a,obj) => a + obj.duration * unitDistance, 0)
        
        Object.values(songObject).forEach((obj,noteNumber)=> {
            const noteDuration = obj.duration
            const durationUnit = obj.duration / bpm


            ctx.fillText(noteHead[durationUnit], 
                startStaffX + initialOffset + (songDistance % barWidth), 
                topLine + 0.5 + halfToneDistance * offsetNoteMap[obj.name] + distanceBetweenStaves * Math.floor(songDistance / barWidth))
            if (durationUnit <= 1) {
                if (offsetNoteMap[obj.name] > 4) {
                    ctx.fillRect(
                        startStaffX + initialOffset + songDistance % barWidth + 10,
                        topLine - 1 + halfToneDistance * offsetNoteMap[obj.name] + distanceBetweenStaves * Math.floor(songDistance / barWidth),
                        2,
                        -30)
                    if (durationUnit === 0.5) {
                        ctx.fillText('\ue240', 
                        startStaffX + initialOffset + songDistance % barWidth + 10, 
                        topLine - 1 + halfToneDistance * offsetNoteMap[obj.name] + distanceBetweenStaves * Math.floor(songDistance / barWidth) - 35)
                    }
                    else if (durationUnit === 0.25) {
                        ctx.fillText('\ue242', 
                        startStaffX + initialOffset + songDistance % barWidth + 10, 
                        topLine - 1 + halfToneDistance * offsetNoteMap[obj.name] + distanceBetweenStaves * Math.floor(songDistance / barWidth) - 35)
                    }
                }
                else {
                    ctx.fillRect(
                        startStaffX + initialOffset + songDistance % barWidth,
                        topLine + 0.5 + halfToneDistance * offsetNoteMap[obj.name] + distanceBetweenStaves * Math.floor(songDistance / barWidth),
                        2,
                        30)
                    if (durationUnit === 0.5) {
                        ctx.fillText('\ue241', startStaffX + initialOffset + songDistance % barWidth,
                        topLine - 1 + halfToneDistance * offsetNoteMap[obj.name] + distanceBetweenStaves * Math.floor(songDistance / barWidth) + 35)
                    }
                    else if (durationUnit === 0.25) {
                        ctx.fillText('\ue243', startStaffX + initialOffset + songDistance % barWidth,
                        topLine - 1 + halfToneDistance * offsetNoteMap[obj.name] + distanceBetweenStaves * Math.floor(songDistance / barWidth) + 35)
                    }
                }
            }
            if (obj.name === "C4") {
                ctx.fillRect(
                    startStaffX + initialOffset + songDistance % (width - 2 * startStaffX - initialOffset) - 0.25 * 30, 
                    topLine + halfToneDistance * offsetNoteMap["C4"] + distanceBetweenStaves * Math.floor(songDistance / barWidth),30,1)      // C3 bar
            }
            songDistance += unitDistance * noteDuration
        })
        console.log(Math.ceil(totalSongDistance))
        Array(Math.ceil(totalSongDistance/barWidth)).fill(null).forEach((v, index) => {                                     // Number of grand staves
            ctx.font = `100px bravura`
            ctx.fillText("\uE000", 25, topLine + 100 + distanceBetweenStaves * index)               // Staff Bracket
            ctx.font = "40px bravura"
            ctx.fillText("\uE050", startStaffX + 10, topLine + 30 + distanceBetweenStaves * index)  // Treble Clef
            ctx.fillText(`\ue062`, startStaffX + 10,topLine + 70.5 + distanceBetweenStaves * index) // Bass Clef    
            Array(2).fill(null).forEach((v, ind) => {                                   // Treble and Bass staves
                ctx.fillRect(startStaffX + 10,topLine + 50 + distanceBetweenStaves*index,30,1) // C3 bar
                
                ctx.fillRect(startStaffX,topLine + distanceBetweenStaves * index,2,100)        // Start Staff
                ctx.fillRect(width - startStaffX,topLine + distanceBetweenStaves * index,2,101)  // End staff

                Array(5).fill(null).forEach( (v,i) =>                                   // Staff lines
                    ctx.fillRect(startStaffX, (topLine) + 10 * i + 60 * ind + distanceBetweenStaves * index, width - 2 * startStaffX, 1) )
        }) })

    }
    var x = 0
    var y = 0
    var dir = "FORWARD"
    var start, previousTimeStamp
    var done = false
    // var currentNoteDuration = 0.5
    // var noteNumber = 0

        // |~~~~~~~~~~~~~~ -- | Bar animation | -- ~~~~~~~~~~~~~~| \\

    function animateBar() {
        let i = 0
        // const unitDistance = 80
        var songDistance = 0
    window.requestAnimationFrame(function loop(timestamp) {
        if (start === undefined) {
            start = timestamp
        }
        const elapsed = timestamp - start
        // Dynamic line movement, based on duration of note and distance to next note
        
        if (x >= Object.values(songObject).slice(0,i).reduce((a,obj) => a + obj.duration * unitDistance, 0) % (CANVAS.width - 2 * startStaffX- initialOffset)
         && i <  Object.values(songObject).length - 1) i++

        const songElapsed = Object.values(songObject).slice(0,i).reduce((a,v) => a + v.duration, 0) * 1000
        const noteElapsed = elapsed - songElapsed
        const noteDuration = songObject[i].duration
        songDistance = Object.values(songObject).slice(0,i).reduce((a,obj) => a + obj.duration * unitDistance, 0)
        
        x = songDistance % (CANVAS.width - 2 * startStaffX- initialOffset) + (noteElapsed*0.001/noteDuration) * unitDistance * noteDuration

        var offsetToFirstLine = topLine + 1
        var totalSongDistance = Object.values(songObject).reduce((a,obj) => a + obj.duration * unitDistance, 0)


        var ctx = ANIMATION.getContext('2d')
        
        ctx.clearRect(0, 0, ANIMATION.width, ANIMATION.height)
        
        // console.log(y, Math.floor(songDistance / barWidth), songDistance)
        y = distanceBetweenStaves * Math.floor(songDistance / barWidth)
        if (x >= totalSongDistance % barWidth
         && y ===  160 * Math.floor(totalSongDistance / barWidth )) {
            x = 0
            i = 0
            songDistance = 0
            start = undefined
            return
        } 
        ctx.fillStyle = "black"
        ctx.fillRect(
            startStaffX + initialOffset + 5.5 + x, 
            offsetToFirstLine + y, 
            1, 
            99)
        window.requestAnimationFrame(loop)
    })}

    BUTTON.addEventListener('click', play)

    async function play() {


        // |~~~~~~~~~~~~~~ -- | Sound | -- ~~~~~~~~~~~~~~| \\


        function playSound(frequency, time, i, noteDuration) {
            const osc =  SOUND.createOscillator()
            const gainNode = SOUND.createGain()
            osc.connect(gainNode)
            gainNode.connect(SOUND.destination)
            gainNode.gain.exponentialRampToValueAtTime(0.1, SOUND.currentTime + time )
            gainNode.gain.linearRampToValueAtTime(0.00001, SOUND.currentTime + noteDuration + time)
            // gainNode.gain.linearRampToValueAtTime(0, SOUND.currentTime + time + duration)
            osc.type = 'triangle'
            osc.frequency.value = frequency
            osc.start(SOUND.currentTime + time)
            // osc.stop(SOUND.currentTime + duration + time)
        }

    animateBar()

    for (var i = 0; i < Object.keys(songObject).length; i++) {
        const noteName = songObject[i].name
        const noteNumber = i
        const noteDuration = songObject[i].duration
        const songElapsed = Object.values(songObject).slice(0,i).reduce((acc, obj)=> acc + obj.duration, 0)
        playSound(frequencyNoteMap[noteName], songElapsed, noteNumber, noteDuration)
    }}

    randomise()

</script>
</html>